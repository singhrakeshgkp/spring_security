# OAuth2
## Table of contents
- [Oauth2](#oauth2)
  - [Grant Types](#grant-types)
  - [How does resource server validate token](#how-does-resource-server-validte-token)
  - [PKCE](#pkce)
  - [Creating Oauth2 Server and generating token](#creating-oauth2-server-and-generating-token)  -- 010-security-oauth2-authserver
  - [Customizing token](#customizing-token)
    - [Customizing token duration](#customizing-token-duration)  -- 011-security-oauth2-authserver
    - [Customizing token type to opaque](#customizing-token-type-to-opaque)  -- 012-security-oauth2-authserver
  - [Authenticate client and user from db](#authenticate-client-and-user-from-db)--013-security-oauth2-authserver
  - [Create resource server and access resources](#create-resource-server-and-access-resources) --014-security-oauth2-resourcesserver
    - [Debug and customize Authentication](#debug-and-customize-authentication) --015-security-oauth2-resourcesserver
      
## Oauth2
- Basic [Diagram](/oauth2-basic.png)
- If u see the above diagram two questions arises which are below.
   - What are the possible grant types?
   - how does the resource server validate and get the data with the access token?
### Grant Types
- Authorization Code Non PKCE based [diagram](/oauth2-authorizationcode.png) . Here is the [diagram for pkce based authorization code](/oauth2-authorizationcode-with-pkce.png)
   - user try to do something
   - request will go to client and then client will redirect the user to auth server login page with redirect url.
   - user will provide the login details and send the request, request will go to auth server
   - Auth server will redirect the user on the required page. here its client page.
   - Client will send authorization code + client cred to auth server to get access token
   - Auth server will send back access token to client.
 
- Client Credentials [diagram](/client-credentials.png)
   - In this type of grant type there is no user intraction
   - client send client id and secret to auth server
   - auth server returns the access token to client
- Refresh token [diagram](/oauth2-refresh-token.png)
   - user send request to client
   - client request for token using refresh token
   - auth server send access token and refresh token
### How does resource server validate token
- Token could be of two types
  - Opaque---> this kind of token do not contains any data.
  - Non Opaque----> This kind of token contains data. ex JWT is the example of non opaque token
 
- How Resource server validate the token is depends on the type of token being used. If opaque token is being used resource serve make a call to ```/introspection``` end point of auth server to get the data. If its non opeque token in this case resource server do not make any call to oauth sever only validate the signature.

## PKCE
#### Proof of Key for code Exchange.
- PKCE Tool can be used to generate code challenge and hash.
- PKCE online Tool for testing ---->```https://example-app.com/pkce```

## Creating Oauth2 Server and generating token
- Create new Spring boot project. and then add oauth2 dependency from mvn repo.
- Create a config class called ```Oauth2ServerConfig.java``` and configure two Filter, immemory credentials and client credential.
- Try to access below url using browser, before that make sure u are passing every details correctly in request param such as client id, code challenge(hash generated by pkce tool)
  ```localhost:8181/oauth2/authorize?response_type=code&client_id=client&scope=openid&redirect_uri=https://docs.spring.io/authorized&code_challenge=kjkfdkfj&code_challenge_method=S256```
- If everything goes fine authorization code will be generated.
- Now Go to your postman and try to generate token using ```localhost:8181/oauth2/token``` endpoint
  - To the ```/token``` endpoint we will pass below req param
  - client_id
  - redirect_uri(should be match what we passed at the time of authorization code generation)
  - grant_type= authorization_code
  - code= authorization code generated by oauth2 server
  - code_verifier = code verifier generated by pkce tool.
 
- If everything goes fine, u wil get access token in the response. Make sure each time while generating the token u are passsing unique authorization code otherwise ```invaid grant type``` error will be returned.
- There is one more endpoint that is ```oauth2/jwks``` which returns kid, kid in jwt token and kid returned by jwks will be same. This kid can be used to match the signature of the generated token.

## Customizing token
### Customizing token duration
- Add following bean in your security configuration class. This bean will add additional claim ```mytestclaim``` in jwt token.
  ```
   @Bean
  public OAuth2TokenCustomizer<JwtEncodingContext> oAuth2TokenCustomizer(){
   return context->{
      context.getClaims().claim("mytestclaim","mytestclaim");
    };
  ```
- Following code can be used to modify the token duration
  ```tokenSettings(TokenSettings.builder().accessTokenTimeToLive(Duration.ofSeconds(900)).build())```

### Customizing token type to opaque
- Add following line in token setting
  ```.accessTokenFormat(OAuth2TokenFormat.REFERENCE)```
- Now run the application and geneate the token.
- Send the token to ```oauth2/instrospect?token?=jfjk``` endpoint, with client credential, u should be able to get the response like below.
  ```json
  {
    "active": true,
    "sub": "test",
    "aud": [
        "client"
    ],
    "nbf": 1703911823,
    "scope": "openid",
    "iss": "http://localhost:8181",
    "exp": 1703912723,
    "iat": 1703911823,
    "jti": "c505823d-a537-4aac-8d4a-4d1077650beb",
    "client_id": "client",
    "token_type": "Bearer"
  }

## Authenticate client and user from db
- Create User and Client Entit. Apart from this also create its respective repository.
- Create Service classess
- Run the application and try to generate the token same way as we did with inmemory credential.
- JWT token should be generated.
## Create resource server and access resources
- Create new spring boot application with spring security and oauth2 resource server dependency
- Configure the Filter and jwk url(this is endpoint from oauth2 server, it will return key that will be used to validate the token)
- Test the application, you should be able to access ```/test``` endpoint if token is correct/valid
